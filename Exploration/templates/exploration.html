{% extends 'base.html' %}

{% block content %}
    <body id="exploration_sec">
        <!-- DNA image at the top -->
        <div class="centered-container">
            <img class="centered-image" src="{{ url_for('static', filename='images/dna.png') }}" alt="Image">
        </div>

        <!-- Title at the top -->
        <h2>{% block title %} Exploration {% endblock %}</h2>
        
        <!-- Subtitle below the title -->
        <h3>Here you can browse GWAS association statistics and overlay multiple GWAS on top of each other.</h3>

        <!-- Here's the Exploration layout -->
        <form id="exploration_form" method="post">
            <!-- Here's the first block: GWAS choice, Reference genome and Browsing options -->
            <!-- Include Select2 CSS and JS -->
            <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
            <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
            <!-- Define styles for the Select2 elements -->
            <style>
                .card { background:#9FD8C6; padding:20px; margin:20px; border-radius:12px; }
                .options-wrapper { display:flex; flex-wrap:nowrap; gap:20px; }

                /* proportions (sum ‚âà 100; gap will cause some shrink, that‚Äôs OK) */
                #gwas_option    { flex: 1 1 40%; min-width:0; }
                #refgen_option  { flex: 1 1 25%; min-width:0; }
                #browse_wrapper { flex: 1 1 35%; min-width:0; }

                /* DO NOT clip the Select2 container */
                .option-box { overflow: visible; text-overflow: clip; }

                /* Make the GWAS Select2 truly fill its column */
                #gwas_option #gwas_select { width:100% !important; display:block; }
                #gwas_option #gwas_select + .select2-container,
                #gwas_option .select2-container { width:100% !important; display:block !important; box-sizing:border-box; }
                #gwas_option .select2-selection--single,
                #gwas_option .select2-selection--multiple { width:100% !important; }

                /* Same for Browsing, for consistency */
                #browse_wrapper #browse_option { width:100% !important; display:block; }
                #browse_wrapper #browse_option + .select2-container,
                #browse_wrapper .select2-container { width:100% !important; display:block !important; box-sizing:border-box; }

                @media (max-width:900px){
                    .option-box { font-size:.9rem; padding:8px; }
                    .option-box h1 { font-size:1.1rem; }
                }
                @media (max-width:600px){
                    .option-box { font-size:.8rem; padding:6px; }
                    .option-box h1 { font-size:1rem; }
                }
            </style>
            <!-- Set divs for the three options -->
            <div class="card">
                <div class="options-wrapper">
                    <!-- GWAS choice -->
                    <div class="option-box" id="gwas_option">
                    <div style="text-align:center;"><h1>GWAS to include</h1></div>
                    <div>
                        <span class="muted">Search a GWAS by trait, author, ID, PMID‚Ä¶</span><br>
                        <select id="gwas_select" name="gwas_data" multiple></select>
                    </div>
                    </div>
                    <!-- Logic to handle selection changes in the GWAS -->
                    <script>
                        $(function () {
                            const $sel = $('#gwas_select');
                            $sel.select2({
                                placeholder: 'Type here...',
                                width: '100%',
                                multiple: true,
                                minimumInputLength: 2,
                                ajax: {
                                url: '/api/gwas',
                                dataType: 'json',
                                delay: 250,
                                data: function (params) {
                                    return {
                                    q: params.term || '',
                                    page: params.page || 1,
                                    eu_only: $('#pop_eu_only').is(':checked') ? 1 : 0
                                    };
                                },
                                processResults: function (data, params) {
                                    params.page = params.page || 1;
                                    return {
                                    results: data.results,
                                    pagination: { more: data.pagination.more }
                                    };
                                },
                                cache: true
                                }
                            });

                            /* Post-init nudge: some themes recalc width at open/close; keep forcing 100% */
                            const fixWidth = function() {
                                $(this).next('.select2-container').css('width', '100%');
                                };
                                $sel.on('select2:open select2:close', fixWidth);
                                fixWidth.call($sel[0]);  // run once after init

                            // --- Preselect previously chosen studies from Flask context (if any) ---
                            // 'gwas' should be a list of study IDs you stored in the session or passed into the template
                            const preselected = {{ (gwas or []) | tojson | safe }};
                            preselected.forEach(function (id) {
                                // If you don't have the label, use the ID as fallback; Select2 will replace the text
                                // on first remote response that includes this id.
                                const opt = new Option(id, id, true, true);
                                $sel.append(opt).trigger('change');
                            });
                        });
                    </script>

                    <!-- Reference genome -->
                    <div class="option-box" id="refgen_option">
                    <div style="text-align:center;"><h1>Reference Genome</h1></div>
                    <div style="text-align:center;">
                        <label><input type="radio" name="refGenome" id="GRCh37" value="GRCh37" checked> GRCh37</label><br>
                        <label><input type="radio" name="refGenome" id="GRCh38" value="GRCh38" {% if refGenome == 'GRCh38' %} checked {% endif %}> GRCh38</label>
                    </div>
                    </div>

                    <!-- Browsing option -->
                    <div class="option-box" id="browse_wrapper">
                    <div style="text-align:center;"><h1>Browsing options</h1></div>
                    <style>
                        #browse_option { height:30px; font-size:16px; }
                    </style>
                    <div>
                        <span class="muted">Locus/Interval/RsID/Gene</span><br>
                        <select id="browse_option" name="browse"></select><br>
                        <script>
                            $(function () {
                                const $browse = $('#browse_option');
                                $browse.select2({
                                placeholder: 'Type rsID (e.g., rs7412), gene (e.g., APOE), or paste chr:start-end',
                                width: '100%',
                                minimumInputLength: 2,
                                tags: true,
                                createTag: function (params) {
                                    const term = $.trim(params.term || '');
                                    const isCoord = /^\d{1,2}:\d+(-\d+)?$/i.test(term);
                                    const isRS   = /^rs\d+/i.test(term);
                                    return isCoord && !isRS ? { id: term, text: term } : null;
                                },
                                ajax: {
                                    url: '/api/locus',
                                    dataType: 'json',
                                    delay: 200,
                                    data: function (params) { return { q: params.term || '', page: params.page || 1 }; },
                                    processResults: function (data, params) {
                                    params.page = params.page || 1;
                                    return { results: data.results, pagination: { more: data.pagination.more } };
                                    },
                                    cache: true
                                }
                                });

                                // ‚¨áÔ∏è use browse_value instead of request.form
                                const prev = {{ (browse_value or '') | tojson | safe }};
                                if (prev) {
                                const opt = new Option(prev, prev, true, true);
                                $browse.append(opt).trigger('change');
                                }
                            });
                        </script>
                        Window <input type="range" min="1000" max="250000" step="1000" name="window" value="{{ window }}" oninput="updateValue(this.value)">
                        <p>Current value: <span id="slider-value">{{ window }}</span></p>
                        <small style="color: blue;">Example: APOE / rs7412</small>
                    </div>
                    </div>
                </div>

                <!-- Hidden console_id so backend knows where to send logs -->
                <input type="hidden" name="console_id" value="{{ console_id }}">

                <!-- Submit button row -->
                <div class="submit-container">
                    <button id="submit_button" class="submit-btn">
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">Show region!</span>
                    </button>
                </div>
                <!-- Small text explaining the console -->
                <div style="text-align:center; font-size:14px; color:gray;">
                    <em>Note: once you click "Show region!", the exploration will start in the background and you can monitor its progress in the console on the left. When the job is done, the page will reload automatically to show the results. If you selected multiple studies or a wide region to be displayed, it may take some time to render.</em>
                </div>

                <script>
                    document.getElementById('exploration_form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const fd = new FormData(e.target);
                        // (no consoleAppend here)
                        const resp = await fetch('/exploration/run', { method: 'POST', body: fd });
                        if (!resp.ok) {
                            consoleAppend('[error] failed to start job'); 
                            return;
                        }

                        startStatusPolling();
                    });

                    // After your existing EventSource setup:
                    // reload when the background job signals completion
                    // (only if you want the page to render results automatically)
                    evt.onmessage = (e) => {
                        try {
                        const payload = JSON.parse(e.data);
                        if (payload.message) consoleAppend(payload.message);
                        if (payload.message === '[done]') {
                            location.href = `/exploration/?cid=${encodeURIComponent('{{ console_id }}')}`;
                        }
                        } catch { consoleAppend(e.data || '[event]'); }
                    };
                </script>
            </div> 

            <!-- ===== Side panel + Plot (25% / 75%) ===== -->
            <style>
                /* Prevent horizontal scrolling caused by oversized children */
                html, body { max-width: 100%; overflow-x: hidden; }

                /* Two-column layout: 25% sidebar, 75% main */
                .layout-row{
                    display: grid;
                    grid-template-columns: 30% 70%;
                    gap: 24px;
                    width: 100%;
                    padding: 0 20px;
                    box-sizing: border-box;
                    align-items: start;
                }

                /* Sidebar styling */
                .side{
                    background:#E0E5F0;
                    border-radius:12px;
                    padding:10px;
                    text-align:center;
                    box-sizing:border-box;
                    min-width:0;   /* allow content to shrink without forcing the grid wider */
                }

                /* Main column */
                .main{
                    min-width:0;
                    display:flex;
                    flex-direction:column;
                    align-items:center; /* center inner content (plot) */
                    box-sizing:border-box;
                }

                /* Plot wrapper: width-based, square (height = width) */
                .plot-wrap.square{
                    width: 100%;            /* 100% of main column width */
                    aspect-ratio: 1 / 1;   /* auto height from width (keeps it square) */
                    position: relative;
                }

                /* Make Plotly fill the wrapper */
                .plot-wrap .plotly-graph-div,
                .plot-wrap .js-plotly-plot,
                .plot-wrap .plot-container,
                .plot-wrap .svg-container{
                    width: 100% !important;
                    height: 100% !important;
                }

                /* Tables fill the sidebar; scroll inside if tall/wide */
                .table-wrap{ width:100%; overflow:auto; }
                .scrollable-table{
                    width: max-content;        /* allows horizontal scroll for many columns */
                    table-layout: fixed;       /* fixed column boxes */
                    border-collapse: collapse;
                }
                .scrollable-table th,
                .scrollable-table td{
                    min-width: 120px;          /* tweak per your needs */
                    padding: 6px 8px;
                    box-sizing: border-box;
                    white-space: normal;       /* allow wrapping */
                    word-break: break-word;    /* break long words if needed */
                    overflow-wrap: anywhere;   /* break unbroken strings (e.g. rsids, loci) */
                    vertical-align: top;
                }

                /* Console phase styles (kept here to avoid inline <style> duplication) */
                #op_console .phase { opacity: .6; }
                #op_console .phase.active { opacity: 1; }
                #op_console .phase.done { opacity: 1; }
                #op_console .line:first-child { margin-bottom: 8px; }
            </style>
            <div class="page-container">
            <div class="layout-row">
                <!-- ===== Sidebar (25%) ===== -->
                <aside class="side">
                <!-- Console box -->
                <div id="op_console" style="
                    border-radius:10px;
                    background:#0b3d36;
                    color:#e5fff9;
                    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                    font-size: 12px;
                    line-height: 1.4;
                    padding:10px 12px;
                    margin-bottom:12px;
                    height:100px;
                    overflow:auto;
                    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
                ">
                    <div class="line" data-static="1">snpXplorer console</div>
                    <div class="line" data-static="1">&nbsp;</div>
                    <div class="line" id="status-line">Waiting for job to be executed</div>
                </div>

                <script>
                    // Phases in the exact order your run_pipeline() publishes:
                    const PHASES = [
                    'Finding genomic location',
                    'Gathering data of interest',
                    'Rendering plots',
                    'Preparing tables'
                    ];
                    function consoleInitPhases() {
                    const box = document.getElementById('op_console');
                    box.innerHTML = '';
                    const hdr = document.createElement('div');
                    hdr.className = 'line'; hdr.textContent = 'snpXplorer console'; box.appendChild(hdr);
                    const spacer = document.createElement('div');
                    spacer.className = 'line'; spacer.textContent = ''; box.appendChild(spacer);
                    PHASES.forEach((p, i) => {
                        const line = document.createElement('div');
                        line.className = 'line phase'; line.dataset.phase = p; line.dataset.index = i;
                        line.textContent = `‚Ä¢ ${p}`; box.appendChild(line);
                    });
                    }
                    function markActive(phaseName) {
                    const box = document.getElementById('op_console');
                    const current = box.querySelector('.phase.active');
                    if (current && current.dataset.phase !== phaseName) {
                        current.classList.remove('active'); current.classList.add('done');
                        current.textContent = `‚úÖ ${current.dataset.phase}`;
                    }
                    const target = Array.from(box.querySelectorAll('.phase')).find(el => el.dataset.phase === phaseName);
                    if (target) { target.classList.add('active'); target.classList.remove('done'); target.textContent = `‚è≥ ${phaseName}`; }
                    }
                    function markAllDone() {
                    const active = document.querySelector('#op_console .phase.active');
                    if (active) { active.classList.remove('active'); active.classList.add('done'); active.textContent = `‚úÖ ${active.dataset.phase}`; }
                    }
                    function consoleAppend(text) {
                    const box = document.getElementById('op_console');
                    const line = document.createElement('div');
                    line.className = 'line'; line.textContent = text; box.appendChild(line);
                    box.scrollTop = box.scrollHeight;
                    }
                    function consoleSet(text) {
                    const status = document.getElementById('status-line');
                    if (status) { status.textContent = text; document.getElementById('op_console').scrollTop = op_console.scrollHeight; }
                    else { consoleAppend(text); }
                    }
                    function consoleClear(keepHeader=true) {
                    const box = document.getElementById('op_console');
                    if (keepHeader) {
                        const header = Array.from(box.querySelectorAll('.line[data-static="1"]'));
                        box.innerHTML = ''; header.forEach(h => box.appendChild(h));
                        const s = document.createElement('div'); s.className = 'line'; s.id = 'status-line';
                        s.textContent = 'Waiting for job to be executed'; box.appendChild(s);
                    } else { box.innerHTML = ''; }
                    }
                    let spinnerTimer = null;
                    function startSpinner(base='Gathering data') {
                    stopSpinner(); let dots = 0;
                    spinnerTimer = setInterval(() => {
                        dots = (dots + 1) % 4; consoleSet(`${base}${'.'.repeat(dots)}`);
                    }, 500);
                    }
                    function stopSpinner(doneText) {
                    if (spinnerTimer) { clearInterval(spinnerTimer); spinnerTimer = null; }
                    if (doneText) consoleSet(doneText);
                    }
                    consoleInitPhases();

                    // SSE hookup
                    const CONSOLE_ID = '{{ console_id }}';
                    const evt = new EventSource(`/events?cid=${encodeURIComponent(CONSOLE_ID)}`);

                    function matchPhase(msg) {
                        const lower = msg.toLowerCase();
                        for (const p of PHASES) {
                            if (lower.startsWith(p.toLowerCase())) return p;
                        }
                        return null;
                    }

                    evt.onmessage = (e) => {
                        try {
                            const payload = JSON.parse(e.data || '{}');
                            const msg = payload.message || '';
                            if (!msg || msg === '__hello__') return;
                            if (msg === 'Starting‚Ä¶') return;

                            const phase = matchPhase(msg);
                            if (phase) {
                                markActive(phase);
                            } else if (/^\[error\]/i.test(msg)) {
                                consoleAppend(msg);
                            } else {
                                consoleAppend(msg);
                            }
                        } catch {
                            consoleAppend(e.data || '[event]');
                        }
                    };

                    evt.onerror = () => {
                        consoleAppend('[connection lost, retrying‚Ä¶]');
                    };

                    let statusTimer = null;

                    function startStatusPolling() {
                        // avoid multiple timers if user spam-clicks
                        if (statusTimer) return;

                        const cid = '{{ console_id }}';  // same ID used by backend for this job

                        statusTimer = setInterval(async () => {
                            try {
                                const res = await fetch(`/exploration/status?cid=${encodeURIComponent(cid)}`);
                                if (!res.ok) return;

                                const data = await res.json();
                                if (data.done) {
                                    clearInterval(statusTimer);
                                    statusTimer = null;
                                    window.location.href = `/exploration/?cid=${encodeURIComponent(cid)}`;
                                }
                            } catch (err) {
                                // ignore network hiccups, try again on next tick
                            }
                        }, 5000); // every 5 seconds, adjust as you like
                    }
                </script>

                <!-- GWAS info -->
                <h3 class="visualization-options">GWAS Information</h3>
                <div class="table-wrap" style="max-height: 220px;">
                    <table class="scrollable-table">
                    <thead>
                        <tr>
                        <th>Trait</th>
                        <th>ID</th>
                        <th>PMID</th>
                        <th>Author</th>
                        <th>Year</th>
                        <th>Sample Size</th>
                        <th>Build</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table_info %}
                        <tr>
                        <td>{{ row['Trait'] }}</td>
                        <td>{{ row['ID'] }}</td>
                        <td>{{ row['PMID'] }}</td>
                        <td>{{ row['Author'] }}</td>
                        <td>{{ row['Year'] }}</td>
                        <td>{{ row['Sample Size'] }}</td>
                        <td>{{ row['Build'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                <hr style="margin: 12px 0;">

                <!-- Visualization options (kept exactly as yours) -->
                <style>
                    .visualization-options { margin-bottom: 1px; margin-top: 1px; }
                    .radio-title { font-size: 16px; margin-bottom: 5px; margin-top: 5px; }
                    .vis-options-row {
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: center;   /* horizontally center each row */
                        gap: 5px 20px;            /* row/column gaps */
                        margin-bottom: 20px;
                    }

                    /* each box ~20‚Äì25% of the sidebar, wrapping will give you 3 + 2 */
                    .vis-box {
                        flex: 0 1 20%;
                        min-width: 140px;
                        box-sizing: border-box;
                    }

                    /* kill any old floats if still present */
                    .vis-box {
                        float: none !important;
                    }
                </style>
                <h3 class="visualization-options">Visualization options</h3>
                <div class="vis-options-row">
                    <div class="vis-box">
                        <h6 class="radio-title">Y-axis</h6>
                        <input type="radio" name="axestype" id="manh" value="manh" checked> Pvalue <br>
                        <input type="radio" name="axestype" id="beta" value="beta" {% if axestype == 'beta' %} checked {% endif %}> Beta
                    </div>

                    <div class="vis-box">
                        <h6 class="radio-title">Appearance</h6>
                        <input type="radio" name="plotype" id="Scatter" value="Scatter" checked> Scatter <br>
                        <input type="radio" name="plotype" id="Smooth" value="Smooth" {% if plotype == 'Smooth' %} checked {% endif %}> Smooth
                    </div>

                    <div class="vis-box">
                        <h6 class="radio-title">Exons</h6>
                        <input type="radio" name="exons" id="No" value="No" checked> No <br>
                        <input type="radio" name="exons" id="Yes" value="Yes" {% if exons == 'Yes' %} checked {% endif %}> Yes
                    </div>

                    <div class="vis-box">
                        <h6 class="radio-title">Recombination</h6>
                        <input type="radio" name="recomb" id="No" value="No" checked> No <br>
                        <input type="radio" name="recomb" id="Yes" value="Yes" {% if recomb == 'Yes' %} checked {% endif %}> Yes
                    </div>

                    <div class="vis-box">
                        <h6 class="radio-title">Y-range</h6>

                        <label><input type="radio" name="y_range" value="Auto"  checked> Auto</label><br>
                        <label><input type="radio" name="y_range" value="Manual" {% if y_range=='Manual' %}checked{% endif %}> Manual</label>

                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

                        <div id="y-manual-wrap" style="margin-top:10px; display:none;">
                            <div id="y-slider"></div>
                            <div style="margin-top:5px; font-size:12px;">Min: <span id="min-val"></span>, Max: <span id="max-val"></span></div>
                        </div>

                        <!-- values to submit with the form -->
                        <input type="hidden" name="y_min" id="y_min">
                        <input type="hidden" name="y_max" id="y_max">
                    </div>
                </div>
                <script>
                    (function () {
                        const radios = document.querySelectorAll('input[name="y_range"]');
                        const wrap   = document.getElementById('y-slider');
                        const minOut = document.getElementById('min-val');
                        const maxOut = document.getElementById('max-val');
                        const yMinIn = document.getElementById('y_min');
                        const yMaxIn = document.getElementById('y_max');

                        // init slider
                        noUiSlider.create(wrap, {
                        start: [0, 25],
                        connect: true,
                        range: { min: 0, max: 50 },
                        step: 1
                        });

                        // update outputs + hidden inputs
                        wrap.noUiSlider.on('update', (values) => {
                        const v0 = Math.round(values[0]), v1 = Math.round(values[1]);
                        minOut.textContent = v0; maxOut.textContent = v1;
                        yMinIn.value = v0; yMaxIn.value = v1;
                        });

                        function refresh() {
                            const val = document.querySelector('input[name="y_range"]:checked')?.value;
                            document.getElementById('y-manual-wrap').style.display = (val === 'Manual') ? 'block' : 'none';
                        }

                        radios.forEach(r => r.addEventListener('change', refresh));
                        // initial state (respect server value if provided)
                        refresh();
                    })();
                </script>

                <!-- SV type toggles -->
                <div style="clear: both; text-align: center;">
                    <h6 class="radio-title">Structural Variants (SV)</h6>
                    <label><input type="checkbox" name="sv_source" value="tr" {% if 'tr' in svtypes %} checked {% endif %}> Tandem Repeats</label>
                    <label><input type="checkbox" name="sv_source" value="sine" {% if 'sine' in svtypes %} checked {% endif %}> SINE</label>
                    <label><input type="checkbox" name="sv_source" value="line" {% if 'line' in svtypes %} checked {% endif %}> LINE</label>
                    <label><input type="checkbox" name="sv_source" value="ltr" {% if 'ltr' in svtypes %} checked {% endif %}> LTR</label>
                    <label><input type="checkbox" name="sv_source" value="all" {% if 'all' in svtypes %} checked {% endif %}> All</label>
                    <br>
                </div>
                <br><br>

                <!-- LD info -->
                <div style="clear: both; text-align: center;">
                    <h6 class="radio-title">Linkage Disequilibrium (LD)</h6>
                    <input type="radio" name="ld" id="No" value="No" checked> No LD <br>
                    <input type="radio" name="ld" id="Yes" value="Yes" {% if ld == 'Yes' %} checked {% endif %}> Yes
                </div>
                    <small style="text-align: left; color: red; font-weight: bold;">LD is shown only when a single study is visualized.</small>
                    <br>
                    <small style="text-align: left; color: blue;">LD is calculated in European individuals.</small>
                <br><br>

                <!-- Haplotypes -->
                <div style="clear: both; text-align: center;">
                    <h6 class="radio-title">Haplotypes</h6>
                    <input type="radio" name="plotHaplo" id="No" value="No" checked> No Haplotypes <br>
                    <input type="radio" name="plotHaplo" id="Yes" value="Yes" {% if plotHaplo == 'Yes' %} checked {% endif %}> Yes
                </div>
                    <small style="text-align: left; color: red; font-weight: bold;">Haplotypes can be shown with multiple studies.</small>
                    <br>
                    <small style="text-align: left; color: blue;">Haplotypes are derived from European individuals.</small>
                <br><br>
                <hr style="margin: 12px 0;">

                <!-- SNP table -->
                <h3 class="visualization-options">SNPs table</h3>
                <div class="table-wrap" style="max-height: 300px;">
                    <table class="scrollable-table">
                    <thead>
                        <tr>
                        <th>Locus</th>
                        <th>RsID</th>
                        <th>Trait</th>
                        <th>Alleles</th>
                        <th>Frequency</th>
                        <th>Beta (SE)</th>
                        <th>Pvalue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table_snps %}
                        <tr>
                        <td>{{ row['Locus'] }}</td>
                        <td>{{ row['Rsid'] }}</td>
                        <td>{{ row['Gwas'] }}</td>
                        <td>{{ row['Alleles'] }}</td>
                        <td>{{ row['EAF'] }}</td>
                        <td>{{ row['Beta_SE'] }}</td>
                        <td>{{ row['Pvalue'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                <small style="text-align: left; color: blue;">Alleles: Effect/Non-Effect - Pvalue: log10 scale</small>
                <br><br>
                <a href="{{ url_for('download_snp_table') }}">Download SNPs as CSV</a>
                <hr style="margin: 12px 0;">

                <!-- SV table -->
                <h3 class="visualization-options">Structural Variants</h3>
                <div class="table-wrap" style="max-height: 200px;">
                    <table class="scrollable-table">
                    <thead>
                        <tr>
                        <th>Locus</th>
                        <th>Length (bp)</th>
                        <th>Class</th>
                        <th>Name</th>
                        <th>Family</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table_svs %}
                        <tr>
                        <td>{{ row['Region'] }}</td>
                        <td>{{ row['len'] }}</td>
                        <td>{{ row['repClass'] }}</td>
                        <td>{{ row['repName'] }}</td>
                        <td>{{ row['repFamily'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                <br><br>
                <a href="{{ url_for('download_sv_table') }}">Download SVs as CSV</a>
                <hr style="margin: 12px 0;">

                <!-- GWAS-catalog table -->
                <h3 class="visualization-options">GWAS Catalog</h3>
                <div class="table-wrap" style="max-height: 300px;">
                    <table class="scrollable-table">
                    <thead>
                        <tr>
                        <th>Locus</th>
                        <th>RsID</th>
                        <th>Gene</th>
                        <th>Trait</th>
                        <th>Pubmed</th>
                        <th>Pvalue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in table_gwas %}
                        <tr>
                        <td>{{ row['Locus'] }}</td>
                        <td>{{ row['snp'] }}</td>
                        <td>{{ row['gene'] }}</td>
                        <td>{{ row['trait'] }}</td>
                        <td>{{ row['pubmed_id'] }}</td>
                        <td>{{ row['pvalue'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                <br>
                <a href="{{ url_for('download_gwascat_table') }}">Download GWAS-Catalog as CSV</a>
                <hr style="margin: 12px 0;">

                <!-- GTEx Expression -->
                <a href="{{ url_for('download_gtex_expression') }}">Download GTEx expression as CSV</a>
                <hr style="margin: 12px 0;">

                <!-- Download links -->
                <a href="{{ url_for('download_snp_plot') }}">Download Main SNP plot</a>
                <br><br>
                <a href="{{ url_for('download_gtex_plot') }}">Download GTEx plot</a>
                            
                <!-- Leave a Feedback -->
                <hr style="margin: 12px 0;">
                <br><br>
                <a href="{{ url_for('about') }}#about">Tell us what you think!</a>            
            </aside>

                <!-- ===== Main plot area (75%) ===== -->
                <main class="main">
                {% if plot_url %}
                <div class="info-wrap">
                    <span class="info-icon">‚ìò</span>
                    <div class="info-tip">
                    This plot shows GWAS association signals across the selected region.
                    Genomic position is shown on the X-axis, and
                    {% if axestype == 'manh' %}P-values{% else %}effect sizes (Beta){% endif %} on the
                    Y-axis. Hover points for SNP-level details (only high significance).
                    The panels below show the genes and structural variants (when selected) in the region.
                    </div>
                </div>
                <div class="plot-wrap square">
                    {{ plot_url|safe }}
                </div>
                <script>
                    // Keep Plotly square & responsive to main column width
                    (function () {
                    const wrap = document.querySelector('.plot-wrap.square');
                    if (!wrap) return;
                    const gd = wrap.querySelector('.plotly-graph-div');
                    if (!gd || typeof Plotly === 'undefined') return;
                    function resize(){
                        const w = wrap.clientWidth;
                        Plotly.relayout(gd, { width: w, height: w });
                    }
                    // Ensure the inner div fills the wrapper
                    gd.style.width='100%';
                    gd.style.height='100%';
                    requestAnimationFrame(resize);
                    window.addEventListener('resize', resize);
                    })();
                </script>
                {% endif %}

                {% if plot_beta %}
                <div class="info-wrap">
                    <span class="info-icon">‚ìò</span>
                    <div class="info-tip">
                    This plot shows Effect sizes (X-axis) and allele frequency (Y-axis) across the 
                    selected region. Hover points for SNP-level details.
                    </div>
                </div>
                <div style="width:100%; margin-top:24px; height:500px; overflow-y:auto;">
                    {{ plot_beta|safe }}
                </div>
                {% endif %}

                {% if plot_gtex %}
                <div class="info-wrap">
                    <span class="info-icon">‚ìò</span>
                    <div class="info-tip">
                    This plot shows gene expression levels across different human tissues from 
                    the GTEx project. Hover bars for tissue-level details.
                    </div>
                </div>
                <div style="width:90%; margin-top:24px; height:800px; overflow-y:auto;">
                    {{ plot_gtex|safe }}
                </div>
                {% endif %}
                </main>

            </div>
            </div>
        </form>

        <!-- Footnote images -->
        <div class="image-container-foot">
            <img src="{{ url_for('static', filename='images/amstUMC.jpg') }}" alt="ams">
            <img src="{{ url_for('static', filename='images/tudelft1.png') }}" alt="tud">
            <img src="{{ url_for('static', filename='images/github.png') }}" alt="gith">
        </div>
    </body>
{% endblock %}
