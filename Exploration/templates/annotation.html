{% extends 'base.html' %}

{% block content %}
    <body id="annotation_sec">
        <!-- DNA image at the top -->
        <div class="centered-container">
            <img class="centered-image" src="{{ url_for('static', filename='images/dna.png') }}" alt="Image">
        </div>

        <!-- Title at the top -->
        <h2>{% block title %} Annotation {% endblock %}</h2>
        
        <!-- Subtitle below the title -->
        <h3>Performs annotation analysis or gene-set enrichment analysis using your SNPs as input. You just need to paste the SNPs of interest in the text area below, provide your email and you will receive the results by email.</h3>
        
        <form id="annotationForm" method="post" onsubmit="return validateForm()">
            <div class="annotation-grid">

                <!-- COLUMN 1: List of variants (spans both rows by grid) -->
                <div class="col-list card green" style="margin: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0;">List of variants</h4>
                    <button type="button"
                            onclick="fillDefaultSNPs()"
                            style="background:#2563eb; color:#fff; border:none; border-radius:999px;
                                padding:4px 8px; font-size:10px; cursor:pointer; line-height:1;">
                    Use example
                    </button>
                </div>

                <textarea id="SNPlist" name="SNPlist"
                    placeholder="Paste variants of interest. &#10;&#13; The format will be derived. Please paste 1 variant per line, no commas or colons. &#10;&#13; Paste up to 1,000 SNPs if Analysis type is 'Gene-set enrichment analysis' and up to 10,000 SNPs in case of 'SNP-gene annotation'. &#10;&#13;&#10;&#13; Example: &#10;&#13; rs7412 &#xA; rs123484"
                    rows="20" cols="28" style="font-size: 14px;">{{ request.form.get('SNPlist', '') }}</textarea>

                <small style="display:block; margin-top:6px; opacity:0.85;">
                    Tip: click “Use example” to load a default set.
                </small>
                </div>

                <!-- COLUMN 2: Reference + Analysis + conditional GSEA (stacked, stays in its own column) -->
                <div class="col-settings" style="margin: 20px; display:flex; flex-direction:column; gap:20px;">

                <div class="card orange" style="width:100%;">
                    <h4>Reference Genome</h4>
                    <input type="radio" name="annotRefGen" id="GRCh37" value="GRCh37" checked> GRCh37 (hg19) </input><br>
                    <input type="radio" name="annotRefGen" id="GRCh38" value="GRCh38"> GRCh38 (hg38) </input>
                </div>

                <div class="card teal" style="width:100%;">
                    <h4>Analysis type</h4>
                    <input type="radio" name="analType" id="Annot" value="Annot" checked> Annotation </input><br>
                    <input type="radio" name="analType" id="GSEA" value="GSEA"> Gene-set Enrichment Analysis </input>
                </div>

                <!-- In case analysis type is gsea, need to choose the sources for enrichment -->
                <div id="annot_gseaSources" class="card" style="display:none; width:100%;">
                    <h6>Enrichment Gene-sets</h6>
                    <input type="checkbox" name="EnrichSource" value="Default" checked> Default (GO:BP) <br>
                    <input type="checkbox" name="EnrichSource" value="KEGG"> KEGG <br>
                    <input type="checkbox" name="EnrichSource" value="Reactome"> Reactome <br>
                    <input type="checkbox" name="EnrichSource" value="Wiki"> Wiki Pathways <br>
                    <br><small>By default, Biological Processes from Gene Ontology (GO:BP) are used because of their tree-like structure which facilitates downstream analyses. Hovewer, you can also use other gene-sets such as KEGG pathways, Reactome pathways and Wiki pathways.</small>
                </div>

                <!-- Javascript to handle the conditional appearance of sources of enrichment checkbox -->
                <script>
                    var analTypeRadios = document.getElementsByName('analType');
                    for (var i = 0; i < analTypeRadios.length; i++) {
                    analTypeRadios[i].addEventListener('change', function() {
                        if (this.value !== 'Annot') {
                        document.getElementById('annot_gseaSources').style.display = 'block';
                        } else {
                        document.getElementById('annot_gseaSources').style.display = 'none';
                        }
                    });
                    }
                </script>

                </div>

                <!-- COLUMN 3: GTEx (will span both rows by grid) -->
                <div class="col-gtex" style="margin: 20px;">
                <div class="card" style="width:100%;">
                    <h4>GTEx tissues</h4>
                    <select name="QTLtissuesAnnot" multiple class="form-control">
                    <option value=""></option>
                    <optgroup label="Tissues">
                        <option value="all_tissues">All_tissues</option>
                        <option value="Adipose_Subcutaneous">Adipose Subcutaneous</option>
                        <option value="Adipose_Visceral_Omentum">Adipose Visceral Omentum</option>
                        <option value="Adrenal_Gland">Adrenal Gland</option>
                        <option value="Artery_Aorta">Artery Aorta</option>
                        <option value="Artery_Tibial">Artery Tibial</option>
                        <option value="Brain_Amygdala">Brain Amygdala</option>
                        <option value="Brain_Anterior_cingulate_cortex_BA24">Brain Anterior cingulate cortex</option>
                        <option value="Brain_Caudate_basal_ganglia">Brain Caudate basal ganglia</option>
                        <option value="Brain_Cerebellar_Hemisphere">Brain Cerebellar Hemisphere</option>
                        <option value="Brain_Cerebellum">Brain Cerebellum</option>
                        <option value="Brain_Cortex">Brain Cortex</option>
                        <option value="Brain_Frontal_Cortex_BA9">Brain Frontal Cortex</option>
                        <option value="Brain_Hippocampus">Brain Hippocampus</option>
                        <option value="Brain_Hypothalamus">Brain Hypothalamus</option>
                        <option value="Brain_Nucleus_accumbens_basal_ganglia">Brain Nucleus accumbens basal ganglia</option>
                        <option value="Brain_Spinal_cord_cervical_c-1">Brain Spinal cord cervical</option>
                        <option value="Brain_Substantia_nigra">Brain Substantia nigra</option>
                        <option value="Breast_Mammary_Tissue">Breast Mammary Tissue</option>
                        <option value="Cells_Cultured_fibroblasts">Cells Cultured fibroblasts</option>
                        <option value="Cells_EBV-transformed_lymphocytes">EBV-transformed lymphocytes</option>
                        <option value="Colon_Sigmoid">Colon Sigmoid</option>
                        <option value="Colon_Transverse">Colon Transverse</option>
                        <option value="Esophagus_Gastroesophageal_Junction">Esophagus Gastroesophageal Junction</option>
                        <option value="Esophagus_Mucosa">Esophagus Mucosa</option>
                        <option value="Esophagus_Muscularis">Esophagus Muscularis</option>
                        <option value="Heart_Atrial_Appendage">Heart Atrial Appendage</option>
                        <option value="Heart_Left_Ventricle">Heart Left Ventricle</option>
                        <option value="Kidney_Cortex">Kidney Cortex</option>
                        <option value="Liver">Liver</option>
                        <option value="Lung">Lung</option>
                        <option value="Minor_Salivary_Gland">Minor Salivary Gland</option>
                        <option value="Muscle_Skeletal">Muscle Skeletal</option>
                        <option value="Nerve_Tibial">Nerve Tibial</option>
                        <option value="Ovary">Ovary</option>
                        <option value="Pancreas">Pancreas</option>
                        <option value="Pituitary">Pituitary</option>
                        <option value="Prostate">Prostate</option>
                        <option value="Skin_Not_Sun_Exposed_Suprapubic">Skin Suprapubic (Not Sun Exposed)</option>
                        <option value="Skin_Sun_Exposed_Lower_leg">Skin Lower leg (Sun Exposed)</option>
                        <option value="Small_Intestine_Terminal_Ileum">Small Intestine Terminal Ileum</option>
                        <option value="Spleen">Spleen</option>
                        <option value="Stomach">Stomach</option>
                        <option value="Testis">Testis</option>
                        <option value="Thyroid">Thyroid</option>
                        <option value="Uterus">Uterus</option>
                        <option value="Vagina">Vagina</option>
                        <option value="Skin_Not_Sun_Exposed_Suprapubic">Skin Suprapubic (Not Sun Exposed)</option>
                        <option value="Skin_Not_Sun_Exposed_Suprapubic">Skin Suprapubic (Not Sun Exposed)</option>
                        <option value="Whole_Blood" selected>Whole Blood</option>
                    </optgroup>
                    </select>
                    <br><small>By default, only Blood is considered. Adding multiple tissues may impact your analysis as a larger number of genes may be associated with each SNP.</small>
                </div>

                <script>
                    $(document).ready(function() {
                    $('select').select2();
                    });
                </script>
                </div>

                <!-- COLUMN 4: Email + Submit (stacked, stays in its own column) -->
                <div class="col-submit" style="margin: 20px; display:flex; flex-direction:column; gap:20px;">

                <div class="card sand" style="width:100%;">
                    <h4>Email</h4>
                    <small>Please enter your email address below. The results will be sent to you:</small>
                    <textarea name="email" style="width: 100%; height: 30px; font-size: 16px;" placeholder="Enter your email here"></textarea>
                </div>

                <div class="card orange" style="width:100%; text-align:center;">
                    <h2>Click to submit</h2>
                    <input type="submit" value="Submit your job here!" onclick="showMessage()" style="font-size: 28px; padding: 10px 20px;">
                    <br>
                    <p style="color: {{ 'red' if messageSubmission == 'Email is not correct. Please check!' else 'green' }}">{{ messageSubmission }}</p>
                </div>

                <script>
                    function validateForm() {
                    var snpList = document.getElementsByName("SNPlist")[0].value;
                    if (snpList.trim() === "") {
                        alert("Please enter the SNPs to annotate in List of variants");
                        return false;
                    }
                    return true;
                    }
                </script>

                </div>

            </div>
            </form>
        
        <script>
            const DEFAULT_SNPS = `rs141749679
            rs143080277
            rs6733839
            rs139643391
            rs3822030
            rs6846529
            rs2245466
            rs112403360
            rs6605556
            rs10947943
            rs143332484
            rs785129
            rs6943429
            rs10952097
            rs76928645
            rs7384878
            rs11771145
            rs1065712
            rs6586028
            rs1582763
            rs12590654
            rs7157106
            rs10131280
            rs8025980
            rs602602
            rs889555
            rs4985556
            rs450674
            rs12446759
            rs72824905
            rs7225151
            rs616338
            rs12151021
            rs149080927
            rs7412
            rs9304690
            rs12459419
            rs587709
            rs1358782
            rs6014724
            rs2830489`;

            function fillDefaultSNPs(){
                const ta = document.getElementById("SNPlist");
                if (!ta) return;

                if (ta.value.trim() && !confirm("Replace current list with the example SNP list?")) return;

                // normalize tabs + line endings + trailing spaces
                const normalized = DEFAULT_SNPS
                .replace(/\t+/g, "")        // remove any tabs
                .replace(/\r\n/g, "\n")     // windows -> unix newlines
                .replace(/\r/g, "\n")       // old mac -> unix newlines
                .split("\n")
                .map(s => s.trim())         // trim each line
                .filter(Boolean)            // drop empty lines
                .join("\n");

                ta.value = normalized;
                ta.focus();
            }

            // Make validateForm use the textarea by id (safer)
            function validateForm() {
                const snpList = document.getElementById("SNPlist").value;
                if (snpList.trim() === "") {
                alert("Please enter the SNPs to annotate in List of variants");
                return false;
                }
                return true;
            }
            </script>

        <!-- Footnote images -->
        <div class="image-container-foot">
            <img src="{{ url_for('static', filename='images/amstUMC.jpg') }}" alt="ams">
            <img src="{{ url_for('static', filename='images/tudelft1.png') }}" alt="tud">
            <img src="{{ url_for('static', filename='images/github.png') }}" alt="gith">
        </div>
    </body>
{% endblock %}
